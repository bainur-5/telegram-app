import { state, setState } from '../store.js';
import { retroButton } from '../ui/components.js';
const ton='/src/assets/toncoin_ton_logo.svg'; const arrow='/src/assets/oi_caret-top.svg';
const items=[{id:1,title:'яйцо',amount:60800,amountLabel:'60.8k',priceTon:5.62,rateText:'0.00009 TON/Egg'},{id:2,title:'яйцо',amount:1946,amountLabel:'1 946',priceTon:.18,rateText:'0.00009 TON/Egg'},{id:3,title:'яйцо',amount:1946,amountLabel:'1 946',priceTon:.18,rateText:'0.00009 TON/Egg'},{id:4,title:'яйцо',amount:1946,amountLabel:'1 946',priceTon:.18,rateText:'0.00009 TON/Egg'},{id:5,title:'яйцо',amount:3675,amountLabel:'3 675',priceTon:.26,rateText:'0.00009 TON/Egg'},{id:6,title:'яйцо',amount:3025,amountLabel:'3 025',priceTon:.22,rateText:'0.00009 TON/Egg'}];
const sort=(arr,f,o)=>[...arr].sort((a,b)=>(o==='asc'?1:-1)*((f==='price'?a.priceTon-b.priceTon:a.amount-b.amount)));
const num=(v)=>{const n=Number(v.replace(',','.').trim()); return Number.isFinite(n)?n:0};
export function renderMarket(){const m=state.market; const visible=sort(m.tab==='all'?items:items.slice(0,3),m.sortField,m.sortOrder); const fee=(num(m.totalTonInput)*5)/100, rec=Math.max(num(m.totalTonInput)-fee,0), valid=num(m.eggsInput)>=100&&num(m.totalTonInput)>0;
 return `<main class="market-page"><div class="market-header"><h2 class="market-header__title">Маркет</h2><button type="button" class="market-header__refresh" aria-label="Обновить">↻</button></div><div class="market-controls"><div class="market-controls__tabs" role="tablist" aria-label="Фильтр"><button type="button" role="tab" data-tab="all" aria-selected="${m.tab==='all'}" class="market-controls__tab ${m.tab==='all'?'is-active':''}">Все</button><button type="button" role="tab" data-tab="mine" aria-selected="${m.tab==='mine'}" class="market-controls__tab ${m.tab==='mine'?'is-active':''}">Ваши</button></div><div class="market-controls__dropdown"><button type="button" class="market-controls__dropdownBtn" aria-expanded="${m.dropdownOpen?'true':'false'}">${m.sortField==='price'?'Цена':'Кол-во'}<span class="market-controls__chevron ${m.dropdownOpen?'is-open':''}">▾</span></button>${m.dropdownOpen?`<ul class="market-controls__dropdownMenu" role="listbox"><li><button type="button" data-sort="price" class="market-controls__dropdownItem ${m.sortField==='price'?'is-active':''}">Цена</button></li><li><button type="button" data-sort="amount" class="market-controls__dropdownItem ${m.sortField==='amount'?'is-active':''}">Кол-во</button></li></ul>`:''}</div><button type="button" class="market-controls__fromTo"><span class="market-controls__fromToIcon ${m.sortOrder==='desc'?'is-desc':''}" aria-hidden="true"><img src="${arrow}" alt="top" /></span></button></div><div class="market-page__createWrap">${retroButton({text:'+ Создать заказ',className:'market-create'})}</div><div class="market-page__grid">${visible.map(it=>`<section class="fcm-card market-item"><svg class="fcm-card__frame" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true"><path d="M9.5 0.5 L99.5 0.5 L99.5 94.2 L91.5 99.5 L0.5 99.5 L0.5 6.8" fill="none" stroke="var(--border)" stroke-width="1" stroke-linejoin="miter" vector-effect="non-scaling-stroke"/></svg><div class="fcm-card__body"><div class="market-item__line"><span class="market-item__lineLabel">${it.title}</span><span class="market-item__pill market-item__pill--blue"><img src="${ton}" alt="" aria-hidden="true" />${it.amountLabel}</span></div><div class="market-item__line"><span class="market-item__lineLabel">Цена</span><span class="market-item__pill market-item__pill--violet"><img src="${ton}" alt="" aria-hidden="true" />${it.priceTon}</span></div><div class="market-item__rate">${it.rateText}</div>${retroButton({text:'Купить',style:'--rgb-w:100%;--rgb-h:24px;--rgb-font-size:12px;--rgb-border:#6DBAFB;--rgb-inner-border:#599FFA;--rgb-top:#6DBAFB;--rgb-bottom:#427FF9;--rgb-dot:rgba(95,205,251,.95);--rgb-background:#6DBAFB;--rgb-text-stroke:#427FF9;'})}</div></section>`).join('')}</div>${m.isCreateOpen?`<div class="create-order-modal__overlay"><div class="create-order-modal" role="dialog" aria-modal="true" aria-label="Создать заказ"><button type="button" class="create-order-modal__close">×</button><h3 class="create-order-modal__title">Создать заказ</h3><div class="create-order-modal__section"><div class="create-order-modal__rowHead"><span>Количество яиц</span><span class="create-order-modal__muted">мин. 100</span></div><input class="create-order-modal__input" id="eggs" type="text" inputmode="decimal" placeholder="Введите количество яиц (мин. 100)" value="${m.eggsInput}"><div class="create-order-modal__quick"><button type="button" data-p="25">25%</button><button type="button" data-p="50">50%</button><button type="button" data-p="75">75%</button><button type="button" data-p="100">МАКС</button></div><p class="create-order-modal__hint">Доступно: 0 яиц</p></div><div class="create-order-modal__section"><div class="create-order-modal__rowHead"><span>Общая цена (TON)</span></div><input class="create-order-modal__input" id="ton" type="text" inputmode="decimal" placeholder="Введите общую цену в TON" value="${m.totalTonInput}"><div class="create-order-modal__summary"><div><span>Комиссия продавца (5%)</span><span>${fee>0?fee.toFixed(3):'—'}</span></div><div><span>Вы получите</span><span class="is-accent">${rec>0?rec.toFixed(3):'—'}</span></div></div></div>${retroButton({text:'Создать заказ',className:'create-order-modal__submit',style:'--rgb-w:100%;--rgb-h:32px;--rgb-border:#6DBAFB;--rgb-inner-border:#599FFA;--rgb-top:#6DBAFB;--rgb-bottom:#427FF9;--rgb-dot:rgba(95,205,251,.95);--rgb-background:#6DBAFB;--rgb-text-stroke:#427FF9;',disabled:!valid})}</div></div>`:''}</main>`;
}

export function bindMarket(root, rerender){
 root.querySelectorAll('[data-tab]').forEach(b=>b.onclick=()=>setState(s=>{s.market.tab=b.dataset.tab;}));
 const d=root.querySelector('.market-controls__dropdownBtn'); if(d) d.onclick=()=>setState(s=>{s.market.dropdownOpen=!s.market.dropdownOpen;});
 root.querySelectorAll('[data-sort]').forEach(b=>b.onclick=()=>setState(s=>{s.market.sortField=b.dataset.sort; s.market.dropdownOpen=false;}));
 const ord=root.querySelector('.market-controls__fromTo'); if(ord) ord.onclick=()=>setState(s=>{s.market.sortOrder=s.market.sortOrder==='asc'?'desc':'asc';});
 const create=root.querySelector('.market-create'); if(create) create.onclick=()=>setState(s=>{s.market.isCreateOpen=true;});
 const overlay=root.querySelector('.create-order-modal__overlay'); if(overlay){overlay.onclick=(e)=>{if(e.target===overlay) setState(s=>{s.market.isCreateOpen=false;});}; root.querySelector('.create-order-modal__close').onclick=()=>setState(s=>{s.market.isCreateOpen=false;}); root.querySelector('#eggs').oninput=e=>setState(s=>{s.market.eggsInput=e.target.value;}); root.querySelector('#ton').oninput=e=>setState(s=>{s.market.totalTonInput=e.target.value;}); root.querySelectorAll('[data-p]').forEach(b=>b.onclick=()=>setState(s=>{s.market.eggsInput='0';})); }
}
